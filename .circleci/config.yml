version: 2
jobs:
  test_linux:
    docker:
      - image: circleci/golang
    working_directory: /go/src/github.com/codeclimate/test-reporter
    setup_remote_docker:
      docker_layer_caching: true
    steps:
      - checkout
      - run: make test

  release_linux:
    docker:
      - image: circleci/golang
    setup_remote_docker:
      docker_layer_caching: true
    steps:
      - checkout
      - run: pip install awscli
      - run: make build-all VERSION=head # TODO: build only linux outside docker
      - run: make publish-head # TODO: only linux

  test_macos:
    macos:
      xcode: "9.0"
    steps:
      - checkout
      - run: brew install golang
      - run:
          name: Setup gopath
          command: |
            mkdir -p ~/gopath/src/github.com/codeclimate/test-reporter
            echo 'export GOPATH=$HOME/gopath' >> "$BASH_ENV"
            . "$BASH_ENV"
            cd $GOPATH/src/github.com/codeclimate/test-reporter
            cp -r ~/project/ $GOPATH/src/github.com/codeclimate/test-reporter/
      - run:
          name: Run tests
          command: |
            cd $GOPATH/src/github.com/codeclimate/test-reporter
            make test

  # release_macos:
  #   macos:
  #     xcode: "9.0"
  #   steps:
  #     - checkout
  #     - run: echo "TODO install go"
  #     - run: echo "TODO build and release macos versions (outside of docker)"

workflows:
  version: 2
  build_deploy:
    jobs:
      - test_linux
      - test_macos
      - release_linux:
          requires:
            - test_linux
            - test_macos
          filters:
            branches:
              only:
                - master
      # - release_macos:
      #     requires:
      #       - test_linux
      #       - test_macos
      #     filters:
      #       branches:
      #         only:
      #           - master

notify:
  webhooks:
    - url: https://cc-slack-proxy.herokuapp.com/circle
